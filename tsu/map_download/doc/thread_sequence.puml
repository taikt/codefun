@startuml
autonumber
box "Map Download App" #LightBlue
  participant Main as "Main Thread"
  participant ListenThread as "Listen Thread (epoll)"
  participant CurlThread as "curlMultiLoop Thread"
end box
participant CurlMulti as "libcurl multi"
participant MapServer as "Map Server"

Main -> Main: Start server
Main --> ListenThread: Create and start listen thread
Main --> CurlThread: Create and start curlMultiLoop thread

ListenThread --> ListenThread: epoll_wait for client connections
ListenThread --> ListenThread: Receive request data from client socket
ListenThread --> CurlThread: Notify new request (create CURL easy handle)

CurlThread --> CurlMulti: Add CURL easy handle
CurlThread -->> CurlMulti: curl_multi_perform (async)
CurlMulti -->> MapServer: Send HTTP requests (async)
MapServer -->> CurlMulti: Return HTTP responses (async)
CurlMulti -->> CurlThread: Call WriteCallback, write data to buffer
CurlThread -->> ListenThread: Notify response ready
ListenThread -->> Main: Optionally log/cleanup
@enduml
