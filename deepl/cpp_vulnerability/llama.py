import asyncio
import subprocess
from pathlib import Path
from ollama import AsyncClient

def is_cpp_file(filename):
    """Kiểm tra xem file có phải là file C++ không."""
    cpp_extensions = {'.cpp', '.h', '.hpp', '.cxx', '.cc'}
    return Path(filename).suffix.lower() in cpp_extensions

def run_clang_analysis(file_path, output_file):
    """Chạy phân tích tĩnh với Clang và ghi kết quả vào file."""
    print(f"Đang phân tích {file_path} với Clang...")
    try:
        # Run clang --analyze
        result = subprocess.run(
            ['clang', '--analyze', str(file_path)],
            capture_output=True,
            text=True,
            check=False
        )
        output = result.stdout + result.stderr
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(f"\n=== Clang Analysis for {file_path} ===\n")
            if output.strip():
                f.write(output + "\n")
            else:
                f.write("Không phát hiện lỗi.\n")
        print(output if output.strip() else "Không phát hiện lỗi với Clang.")
    except FileNotFoundError:
        error_msg = "Lỗi: Clang không được cài đặt hoặc không tìm thấy trong PATH.\n"
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(error_msg)
        print(error_msg)
    except Exception as e:
        error_msg = f"Lỗi khi chạy Clang trên {file_path}: {str(e)}\n"
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(error_msg)
        print(error_msg)

def run_clang_tidy_analysis(file_path, output_file):
    
    """Chạy phân tích tĩnh với Clang-Tidy và ghi kết quả vào file."""
    print(f"Đang phân tích {file_path} với Clang-Tidy...")
    try:
        # Kiểm tra xem file .clang-tidy có tồn tại không
        clang_tidy_config = Path('.clang-tidy')
        if clang_tidy_config.exists():
            command = ['clang-tidy', str(file_path), '--', '-std=c++11']
        else:
            print(f"no .clang-tidy config")
            command = [
                    'clang-tidy', str(file_path),
                    '--checks=clang-analyzer-cplusplus.NewDeleteLeaks,clang-analyzer-core.uninitialized.ArraySubscript',
                    '--', '-std=c++17'
                ]
        result = subprocess.run(
            command,
            capture_output=True,
            text=True,
            check=False
        )
        output = result.stdout + result.stderr
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(f"\n=== Clang-Tidy Analysis for {file_path} ===\n")
            if output.strip():
                f.write(output + "\n")
            else:
                f.write("Không phát hiện lỗi.\n")
        print(output if output.strip() else "Không phát hiện lỗi với Clang-Tidy.")
    except FileNotFoundError:
        error_msg = "Lỗi: Clang-Tidy không được cài đặt hoặc không tìm thấy trong PATH.\n"
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(error_msg)
        print(error_msg)
    except Exception as e:
        error_msg = f"Lỗi khi chạy Clang-Tidy trên {file_path}: {str(e)}\n"
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(error_msg)
        print(error_msg)

def run_cppcheck_analysis(file_path, output_file):
    """Chạy phân tích tĩnh với Cppcheck và ghi kết quả vào file."""
    print(f"Đang phân tích {file_path} với Cppcheck...")
    try:
        # Run cppcheck with common options
        result = subprocess.run(
            ['cppcheck', '--enable=all', '--suppress=missingIncludeSystem', str(file_path)],
            capture_output=True,
            text=True,
            check=False
        )
        output = result.stdout + result.stderr
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(f"\n=== Cppcheck Analysis for {file_path} ===\n")
            if output.strip():
                f.write(output + "\n")
            else:
                f.write("Không phát hiện lỗi.\n")
        print(output if output.strip() else "Không phát hiện lỗi với Cppcheck.")
    except FileNotFoundError:
        error_msg = "Lỗi: Cppcheck không được cài đặt hoặc không tìm thấy trong PATH.\n"
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(error_msg)
        print(error_msg)
    except Exception as e:
        error_msg = f"Lỗi khi chạy Cppcheck trên {file_path}: {str(e)}\n"
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(error_msg)
        print(error_msg)

async def analyze_with_ollama(file_path, content, output_file):
    """
    Gửi nội dung file tới mô hình qwen3 qua ollama để phân tích lỗi và ghi kết quả vào file.
    """
    # Add line numbers to the content
    lines = content.splitlines()
    numbered_content = "\n".join(f"{i+1}: {line}" for i, line in enumerate(lines))
    
    message = {
    "role": "user",
    "content": (
        f"Analyze the following C++ code for potential errors. "
        f"Provide a simple report that indicates which code line has an issue, "
        f"using the line numbers provided in the format 'Line X: ...'. "
        f"Please include simple explanations, and list the issues with their corresponding line numbers.\n\n"
        f"{numbered_content}\n/no_think"
    )
}
    print(f"\nĐang phân tích {file_path} với Ollama (qwen3:8b)...")
    try:
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(f"\n=== Ollama Analysis for {file_path} ===\n")
            response = await AsyncClient().chat(
                model="qwen3:8b", messages=[message], stream=False
            )
            content = response["message"]["content"]
            f.write(content + "\n")
            print(content)
    except Exception as e:
        error_msg = f"Lỗi khi phân tích {file_path} với Ollama: {str(e)}\n"
        with open(output_file, 'a', encoding='utf-8') as f:
            f.write(error_msg)
        print(error_msg)

async def scan_directory(source_dir, output_file):
    """
    Quét tất cả file trong thư mục source, phân tích bằng Clang, Clang-Tidy, Cppcheck và Ollama, ghi kết quả vào file.
    """
    source_path = Path(source_dir)
    if not source_path.exists() or not source_path.is_dir():
        print(f"Lỗi: Thư mục '{source_dir}' không tồn tại hoặc không phải thư mục.")
        return

    print(f"Đang quét thư mục: {source_dir}")
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write("C++ Code Analysis Report\n")
        f.write("=" * 30 + "\n")
    
    for file_path in source_path.rglob('*'):
        if file_path.is_file() and is_cpp_file(file_path):
            try:
                with open(file_path, 'r', encoding='utf-8') as file:
                    content = file.read()
                
                # Run Clang analysis first
                run_clang_analysis(file_path, output_file)
                
                # Run Clang-Tidy analysis second
                #run_clang_tidy_analysis(file_path, output_file)
                
                # Run Cppcheck analysis third
                run_cppcheck_analysis(file_path, output_file)
                
                # Run Ollama analysis last
                await analyze_with_ollama(file_path, content, output_file)
                
            except Exception as e:
                error_msg = f"Lỗi khi đọc file {file_path}: {str(e)}\n"
                with open(output_file, 'a', encoding='utf-8') as f:
                    f.write(error_msg)
                print(error_msg)

if __name__ == "__main__":
    source_directory = "cpp_test"
    output_file = "analysis_report.txt"
    asyncio.run(scan_directory(source_directory, output_file))